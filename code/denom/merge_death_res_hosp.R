
library(fst)
library(data.table)
library(lubridate)

new_merged <- "/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res_death/"

#load death file and resp hosp file and merge
death2000<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2000.fst",columns = c("qid","year","death"))
qid2000<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2000.fst")
setnames(qid2000, "year.medicare", "year")
death2000 <-merge(death2000,qid2000, by = c("qid","year"),all.y=T)
write_fst(death2000, paste0(new_merged,"death2000"))
rm(list=setdiff(ls(),"new_merged"))
gc()
death2001<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2001.fst",columns = c("qid","year","death"))
qid2001<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2001.fst")
setnames(qid2001, "year.medicare", "year")
death2001 <-merge(death2001,qid2001, by = c("qid","year"),all.y=T)
write_fst(death2001, paste0(new_merged,"death2001"))
rm(list=setdiff(ls(),"new_merged"))
gc()
death2002<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2002.fst",columns = c("qid","year","death"))
qid2002<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2002.fst")
setnames(qid2002, "year.medicare", "year")
death2002 <-merge(death2002,qid2002, by = c("qid","year"),all.y=T)
write_fst(death2002, paste0(new_merged,"death2002"))
rm(list=setdiff(ls(),"new_merged"))
gc()
death2003<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2003.fst",columns = c("qid","year","death"))
qid2003<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2003.fst")
setnames(qid2003, "year.medicare", "year")
death2003 <-merge(death2003,qid2003, by = c("qid","year"),all.y=T)
write_fst(death2003, paste0(new_merged,"death2003"))
rm(list=setdiff(ls(),"new_merged"))
gc()
death2004<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2004.fst",columns = c("qid","year","death"))
qid2004<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2004.fst")
setnames(qid2004, "year.medicare", "year")
death2004 <-merge(death2004,qid2004, by = c("qid","year"),all.y=T)
write_fst(death2004, paste0(new_merged,"death2004"))
rm(list=setdiff(ls(),"new_merged"))
gc()
death2005<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2005.fst",columns = c("qid","year","death"))
qid2005<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2005.fst")
setnames(qid2005, "year.medicare", "year")
death2005 <-merge(death2005,qid2005, by = c("qid","year"),all.y=T)
write_fst(death2005, paste0(new_merged,"death2005"))
rm(list=setdiff(ls(),"new_merged"))
gc()
death2006<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2006.fst",columns = c("qid","year","death"))
qid2006<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2006.fst")
setnames(qid2006, "year.medicare", "year")
death2006 <-merge(death2006,qid2006, by = c("qid","year"),all.y=T)
write_fst(death2006, paste0(new_merged,"death2006"))
rm(list=setdiff(ls(),"new_merged"))
gc()
death2007<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2007.fst",columns = c("qid","year","death"))
qid2007<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2007.fst")
setnames(qid2007, "year.medicare", "year")
death2007 <-merge(death2007,qid2007, by = c("qid","year"),all.y=T)
write_fst(death2007, paste0(new_merged,"death2007"))
rm(list=setdiff(ls(),"new_merged"))
gc()
death2008<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2008.fst",columns = c("qid","year","death"))
qid2008<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2008.fst")
setnames(qid2008, "year.medicare", "year")
death2008 <-merge(death2008,qid2008, by = c("qid","year"),all.y=T)
write_fst(death2008, paste0(new_merged,"death2008"))
rm(list=setdiff(ls(),"new_merged"))
gc()
death2009<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2009.fst",columns = c("qid","year","death"))
qid2009<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2009.fst")
setnames(qid2009, "year.medicare", "year")
death2009 <-merge(death2009,qid2009, by = c("qid","year"),all.y=T)
write_fst(death2009, paste0(new_merged,"death2009"))
rm(list=setdiff(ls(),"new_merged"))
gc()
death2010<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2010.fst",columns = c("qid","year","death"))
qid2010<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2010.fst")
setnames(qid2010, "year.medicare", "year")
death2010 <-merge(death2010,qid2010, by = c("qid","year"),all.y=T)
write_fst(death2010, paste0(new_merged,"death2010"))
rm(list=setdiff(ls(),"new_merged"))
gc()
death2011<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2011.fst",columns = c("qid","year","death"))
qid2011<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2011.fst")
setnames(qid2011, "year.medicare", "year")
death2011 <-merge(death2011,qid2011, by = c("qid","year"),all.y=T)
write_fst(death2011, paste0(new_merged,"death2011"))
rm(list=setdiff(ls(),"new_merged"))
gc()
death2012<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2012.fst",columns = c("qid","year","death"))
qid2012<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2012.fst")
setnames(qid2012, "year.medicare", "year")
death2012 <-merge(death2012,qid2012, by = c("qid","year"),all.y=T)
write_fst(death2012, paste0(new_merged,"death2012"))
rm(list=setdiff(ls(),"new_merged"))
gc()
death2013<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2013.fst",columns = c("qid","year","death"))
qid2013<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2013.fst")
setnames(qid2013, "year.medicare", "year")
death2013 <-merge(death2013,qid2013, by = c("qid","year"),all.y=T)
write_fst(death2013, paste0(new_merged,"death2013"))
rm(list=setdiff(ls(),"new_merged"))
gc()
death2014<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2014.fst",columns = c("qid","year","death"))
qid2014<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2014.fst")
setnames(qid2014, "year.medicare", "year")
death2014 <-merge(death2014,qid2014, by = c("qid","year"),all.y=T)
write_fst(death2014, paste0(new_merged,"death2014"))
rm(list=setdiff(ls(),"new_merged"))
gc()
death2015<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2015.fst",columns = c("qid","year","death"))
qid2015<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2015.fst")
setnames(qid2015, "year.medicare", "year")
death2015 <-merge(death2015,qid2015, by = c("qid","year"),all.y=T)
write_fst(death2015, paste0(new_merged,"death2015"))
rm(list=setdiff(ls(),"new_merged"))
gc()
death2016<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/mortality/1999_2016/wu/cache_data/merged_by_year_v2/confounder_exposure_merged_nodups_health_2016.fst",columns = c("qid","year","death"))
qid2016<-read_fst("/nfs/home/J/jok8845/shared_space/ci3_health_data/medicare/gen_admission/1999_2016/Klompmaker/cache_data/hosp_adm/res/correct_followup/confounder_exposure_merged_nodups_health_2016.fst")
setnames(qid2016, "year.medicare", "year")
death2016 <-merge(death2016,qid2016, by = c("qid","year"),all.y=T)
write_fst(death2016, paste0(new_merged,"death2016"))
rm(list=setdiff(ls(),"new_merged"))
gc()
